<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024">
  <title>Breacher Reminder Log</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0a0a0a;
      color: #e0f8ff;
      line-height: 1.6;
      padding: 2rem;
    }
    .container {
      max-width: 1024px;
      margin: auto;
      border: 1px solid #244b5a;
      padding: 2rem;
      border-radius: 12px;
      background: rgba(10, 30, 40, 0.95);
      box-shadow: 0 0 12px #00b4ff33;
    }
    .title {
      font-size: 2.35rem;
      font-weight: bold;
      letter-spacing: 1.4px;
      color: #00b4ff;
      text-shadow: 0 0 8px #00b4ff44, 0 2px 8px #000d;
      margin-bottom: 1em;
      text-align: center;
    }
    .section {
      margin-bottom: 2em;
    }
    .section-title {
      font-size: 1.5rem;
      color: #8defff;
      margin-bottom: 0.6em;
    }
    .checklist-item {
      position: relative;
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
      padding-left: 2.5em;
      margin-bottom: 0.2em;
      background: none;
      user-select: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      min-height: 2.1em;
    }
    .checklist-item:active,
    .checklist-item.dragging {
      opacity: 0.65;
      background: #192631;
    }
    .checklist-item:hover {
      background: #162433;
      color: #64cbff;
    }
    .checklist-item::before {
      content: "⬜";
      position: absolute;
      left: 0.6em;
      color: #aaa;
      transition: color 0.2s;
      font-size: 1.25em;
      top: 0.23em;
    }
    .checklist-item.checked::before {
      content: "✅";
      color: #8fff94;
    }
    .checklist-item.checked {
      color: #b8ffcc;
    }
    .checklist-drag {
      margin-right: 0.8em;
      cursor: grab;
      font-size: 1.3em;
      color: #3ec6fd;
      opacity: 0.93;
      user-select: none;
    }
    .checklist-content {
      display: flex;
      justify-content: flex-start;
      gap: 1em;
      width: 100%;
    }
    .checklist-left, .checklist-right {
      white-space: nowrap;
    }
    .checklist-left {
      text-align: right;
      flex: 2;
    }
    .checklist-divider {
      flex: 0;
      color: #888;
      min-width: 2em;
      text-align: center;
    }
    .checklist-right {
      text-align: left;
      flex: 5;
    }
    .checklist-remove-btn {
      margin-left: 1em;
      color: #ff7373;
      background: none;
      border: none;
      font-size: 1.12em;
      cursor: pointer;
      transition: color 0.17s;
    }
    .checklist-remove-btn:hover {
      color: #ff4040;
    }
    .checklist-placeholder {
      height: 2.2em;
      border: 2px dashed #00b4ff;
      background: #011a2e;
      border-radius: 6px;
      margin: 0.2em 0;
    }
    .add-btn {
      display: block;
      margin: 1em auto 0;
      padding: 0.5em 1.2em;
      font-size: 1rem;
      background-color: #00b4ff;
      color: #000;
      border: none;
      border-radius: 0.5em;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .add-btn:hover {
      background-color: #0096cc;
    }
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAaJ_Xt0l7O4He6YWrx2XWg_xvsPMThnxM",
      authDomain: "breacher-commands.firebaseapp.com",
      databaseURL: "https://breacher-commands-default-rtdb.firebaseio.com",
      projectId: "breacher-commands",
      storageBucket: "breacher-commands.appspot.com",
      messagingSenderId: "521787055932",
      appId: "1:521787055932:web:2c61dee47bd56ed6be4839"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const listRef = ref(db, "reminders");

    let dragSrcKey = null;
    let dragSrcIndex = null;
    let placeholder = null;

    // Helper: returns sorted items by order
    function sortItems(items) {
      return items.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
    }

    onValue(listRef, (snapshot) => {
      const log = document.getElementById("log-section");
      log.innerHTML = '<div class="section-title">Command List</div>';
      // Read all as array, sorted
      const arr = [];
      snapshot.forEach(child => {
        arr.push({ key: child.key, ...child.val() });
      });
      sortItems(arr).forEach((data, idx) => {
        const div = document.createElement('div');
        div.className = 'checklist-item';
        div.draggable = true;
        div.dataset.key = data.key;
        div.dataset.index = idx;
        if (data.checked) div.classList.add('checked');

        // Parse left/right sides
        const parts = data.text.split("-");
        const left = parts[0]?.trim() ?? "";
        const right = parts[1]?.trim() ?? "";

        // Drag handle
        const dragHandle = document.createElement('span');
        dragHandle.className = 'checklist-drag';
        dragHandle.innerHTML = '&#9776;'; // Hamburger/drag icon

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'checklist-remove-btn';
        removeBtn.title = "Remove item";
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("Remove this item?")) {
            remove(ref(db, `reminders/${data.key}`));
          }
        };

        // Content
        const content = document.createElement('div');
        content.className = 'checklist-content';
        content.innerHTML = `
          <span class="checklist-left">${left}</span>
          <span class="checklist-divider">-</span>
          <span class="checklist-right">${right}</span>
        `;

        // Toggle check
        div.onclick = (e) => {
          if (e.target === removeBtn) return; // Don't toggle on remove click
          const checked = !div.classList.contains('checked');
          div.classList.toggle('checked');
          update(ref(db, `reminders/${data.key}`), { checked });
        };

        // DRAG & DROP logic:
        div.addEventListener('dragstart', e => {
          dragSrcKey = data.key;
          dragSrcIndex = idx;
          div.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', '');
        });
        div.addEventListener('dragend', () => {
          dragSrcKey = null;
          dragSrcIndex = null;
          div.classList.remove('dragging');
          if (placeholder) placeholder.remove();
          placeholder = null;
        });
        div.addEventListener('dragover', e => {
          e.preventDefault();
          if (!placeholder) {
            placeholder = document.createElement('div');
            placeholder.className = 'checklist-placeholder';
            div.parentNode.insertBefore(placeholder, div);
          }
        });
        div.addEventListener('dragleave', () => {
          if (placeholder) {
            placeholder.remove();
            placeholder = null;
          }
        });
        div.addEventListener('drop', e => {
          e.preventDefault();
          // Find all item keys in new order
          const items = Array.from(log.querySelectorAll('.checklist-item'));
          const newOrder = items.map(el => el.dataset.key);
          // Update order in Firebase
          newOrder.forEach((key, order) => {
            update(ref(db, `reminders/${key}`), { order });
          });
          if (placeholder) placeholder.remove();
          placeholder = null;
        });

        // Attach drag handle, content, remove button
        div.appendChild(dragHandle);
        div.appendChild(content);
        div.appendChild(removeBtn);
        log.appendChild(div);
      });
    });

    // Add new reminder
    window.addReminder = async function () {
      const text = prompt("Enter your new reminder:");
      if (text) {
        // Find max order:
        onValue(listRef, (snapshot) => {
          let maxOrder = -1;
          snapshot.forEach(child => {
            const order = child.val().order;
            if (typeof order === "number" && order > maxOrder) maxOrder = order;
          });
          push(listRef, { text, checked: false, order: maxOrder + 1 });
        }, { onlyOnce: true });
      }
    };
  </script>
</head>
<body>
  <div class="container">
    <div class="title">Breacher Commands</div>
    <div class="section" id="log-section">
      <div class="section-title">Command List</div>
    </div>
    <button class="add-btn" onclick="addReminder()">+ Add New Command</button>
  </div>
</body>
</html>
